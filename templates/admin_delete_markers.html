{% extends 'base.html' %}
{% block title %}Admin · Delete Markers{% endblock %}

{% block content %}
<style>
  :root{ --muted:#6c757d; --border:#e9ecef; }
  .page-head{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.75rem}
  .page-head h2{margin:0;font-weight:700}
  .chip{display:inline-block;padding:.35rem .6rem;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:600;font-size:.85rem}
  .toolbar{position:sticky;top:16px;z-index:9}
  .table-sm th,.table-sm td{padding:.55rem .65rem;vertical-align:middle}
  .admin-markers-table .text-truncate{max-width:320px}
  @media (max-width:992px){ .admin-markers-table .text-truncate{max-width:220px} }
  @media (max-width:576px){ .admin-markers-table .text-truncate{max-width:160px} }
  .hint{color:var(--muted)}
</style>

{# quick counts #}
{% set total = markers|length %}
{% set with_students = 0 %}
{% for m in markers %}
  {% if (assigned_counts.get(m.id, 0) or 0) > 0 %}
    {% set with_students = with_students + 1 %}
  {% endif %}
{% endfor %}
{% set without_students = total - with_students %}

<div class="page-head">
  <div>
    <h2 class="mb-0 text-danger">Delete Markers</h2>
    <div class="hint">Deleting a marker will unassign all students currently assigned to them. Students remain in the system.</div>
  </div>
  <div class="d-flex gap-2 flex-wrap">
    <span class="chip">Total: {{ total }}</span>
    <span class="chip">With students: {{ with_students }}</span>
    <span class="chip">Empty: {{ without_students }}</span>
  </div>
</div>

<div class="toolbar mb-3">
  <div class="card shadow-sm">
    <div class="card-body py-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-7">
          <label class="form-label mb-1">Search</label>
          <input id="searchInput" class="form-control" type="search" placeholder="Search markers or emails…" aria-label="Search">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Filter</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleWithStudents">
            <label class="form-check-label" for="toggleWithStudents">Show with students only</label>
          </div>
        </div>
        <div class="col-md-2 text-md-end">
          <div class="form-text mt-2 mt-md-0 hint">Use Admin → Assign to reassign first if needed.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle mb-0 admin-markers-table" id="markersTable">
      <thead class="table-light sticky-top">
        <tr class="small text-uppercase">
          <th style="min-width:200px;">Marker (ID)</th>
          <th style="min-width:220px;">Email</th>
          <th class="text-center" style="width:140px;">Assigned Students</th>
          <th class="text-end" style="width:120px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for m in markers %}
          {% set count = assigned_counts.get(m.id, 0) %}
          <tr class="marker-row"
              data-name="{{ (m.username or '')|lower }}"
              data-email="{{ (m.email or '')|lower }}"
              data-has="{{ '1' if count > 0 else '0' }}">
            <td class="text-truncate" title="{{ m.username }} (#{{ m.id }})">
              <span class="fw-semibold">{{ m.username }}</span>
              <span class="text-muted">(#{{ m.id }})</span>
            </td>
            <td class="text-truncate" style="max-width:280px;">
              <a href="mailto:{{ m.email }}" class="text-decoration-none">{{ m.email }}</a>
            </td>
            <td class="text-center">
              {% if count > 0 %}
                <span class="badge bg-warning text-dark">{{ count }}</span>
              {% else %}
                <span class="badge bg-success">0</span>
              {% endif %}
            </td>
            <td class="text-end">
              <form action="{{ url_for('delete_marker', marker_id=m.id) }}" method="post" class="d-inline">
                <button type="submit"
                        class="btn btn-sm {{ 'btn-danger' if count > 0 else 'btn-outline-danger' }}"
                        onclick="return confirm('Delete marker &quot;{{ m.username }}&quot;? {% if count>0 %}This will unassign {{ count }} student(s).{% endif %}');">
                  Delete
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
        {% if markers|length == 0 %}
          <tr><td colspan="4" class="text-center text-muted py-4">No markers found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const q = document.getElementById('searchInput');
  const onlyWith = document.getElementById('toggleWithStudents');
  const rows = Array.from(document.querySelectorAll('#markersTable tbody tr.marker-row'));
  const norm = s => (s||'').toString().trim().toLowerCase();

  function applyFilters(){
    const term = norm(q.value);
    const withOnly = !!onlyWith.checked;
    rows.forEach(tr => {
      const hay = (tr.innerText || '').toLowerCase();
      const ok = (!term || hay.includes(term)) && (!withOnly || tr.dataset.has === '1');
      tr.style.display = ok ? '' : 'none';
    });
  }

  [q, onlyWith].forEach(el => {
    if (el){ el.addEventListener('input', applyFilters); el.addEventListener('change', applyFilters); }
  });

  applyFilters();
})();
</script>
{% endblock %}