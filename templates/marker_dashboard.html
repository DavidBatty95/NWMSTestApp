{% extends 'base.html' %}
{% block title %}Marker · Dashboard{% endblock %}

{% block content %}
<h2 class="mb-1">Welcome, {{ current_user.username }}</h2>
<p class="text-muted">Here’s your dashboard overview.</p>

<div class="row g-3 mb-4">
  <!-- Donut -->
  <div class="col-lg-5">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Your Students · Status</h5>
          <small class="text-muted">Live</small>
        </div>
        <div class="d-flex align-items-center justify-content-center my-2" style="min-height: 220px;">
          <div style="max-width: 320px; width: 100%;">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
        <div class="row text-center mt-2">
          <div class="col-4 mb-2">
            <div class="small text-muted">Unsubmitted</div>
            <div class="fw-semibold">{{ status_counts['Unsubmitted'] }}</div>
          </div>
          <div class="col-4 mb-2">
            <div class="small text-muted">To be Marked</div>
            <div class="fw-semibold">{{ status_counts['To be Marked'] }}</div>
          </div>
          <div class="col-4 mb-2">
            <div class="small text-muted">Marked</div>
            <div class="fw-semibold">{{ status_counts['Marked'] }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div class="col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">At a Glance</h5>
        <div class="row g-3">
          <div class="col-6 col-md-4">
            <div class="border rounded p-3 text-center h-100">
              <div class="small text-muted">Assigned Students</div>
              <div class="display-6">{{ students|length }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="border rounded p-3 text-center h-100">
              <div class="small text-muted">Need Marking</div>
              <div class="display-6">{{ pending|length }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="small text-muted mb-1">Tips</div>
              <ul class="mb-0 small">
                <li>Sorted by least time remaining.</li>
                <li>Overdue items are highlighted.</li>
                <li>Use “Open” to mark now.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Queue -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="card-title mb-0">Workbooks Needing Marking</h5>
      <small class="text-muted">{{ pending|length }} item{{ '' if pending|length == 1 else 's' }}</small>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="min-width: 180px;">Student</th>
            <th>Course</th>
            <th>Workbook</th>
            <th>Submitted</th>
            <th>Deadline</th>
            <th class="text-end" style="min-width: 140px;">Time Remaining</th>
            <th class="text-end" style="width: 120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in pending %}
            {% set s = item.student %}
            {% set sub = item.submission %}
            {% set deadline = item.deadline %}
            {% set time_left = item.time_left %}
            {% set overdue = time_left.total_seconds() < 0 %}
            <tr class="{{ 'table-danger' if overdue else '' }}">
              <td>
                <div class="fw-semibold">{{ s.username }}</div>
                <div class="small text-muted">ID: {{ s.id }}</div>
              </td>
              <td>{{ s.course or '—' }}</td>
              <td>#{{ sub.workbook_number }}</td>
              <td><span title="{{ sub.submission_time }}">{{ sub.submission_time.strftime('%Y-%m-%d %H:%M') }}</span></td>
              <td><span title="{{ deadline }}">{{ deadline.strftime('%Y-%m-%d %H:%M') }}</span></td>
              <td class="text-end">
                {% if overdue %}
                  <span class="text-danger fw-semibold">Overdue</span>
                {% else %}
                  {% set days = time_left.days %}
                  {% set hours = (time_left.seconds // 3600) %}
                  <span class="fw-semibold">{% if days > 0 %}{{ days }}d {% endif %}{{ hours }}h</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{{ url_for('marker_view_student', student_id=s.id) }}" class="btn btn-sm btn-primary">Open</a>
              </td>
            </tr>
          {% endfor %}
          {% if pending|length == 0 %}
            <tr><td colspan="7" class="text-center text-muted py-4">Nothing to mark right now 🎉</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
  (function () {
    const total =
      {{ status_counts['Unsubmitted'] }} +
      {{ status_counts['To be Marked'] }} +
      {{ status_counts['Marked'] }};

    const ctx = document.getElementById('statusChart').getContext('2d');

    const centerText = {
      id: 'centerText',
      afterDraw(chart) {
        const meta = chart.getDatasetMeta(0);
        if (!meta || !meta.data || !meta.data.length) return;
        const p = meta.data[0].getProps(['x','y'], true);
        const { ctx } = chart;
        ctx.save();
        ctx.font = '600 18px system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total.toString(), p.x, p.y);
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial';
        ctx.fillStyle = '#777';
        ctx.fillText('Total', p.x, p.y + 18);
        ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Unsubmitted', 'To be Marked', 'Marked'],
        datasets: [{
          data: [
            {{ status_counts['Unsubmitted'] }},
            {{ status_counts['To be Marked'] }},
            {{ status_counts['Marked'] }}
          ],
          backgroundColor: ['#9e9e9e', '#ffc107', '#4CAF50'],
          borderColor: 'rgba(255,255,255,0.9)',
          borderWidth: 2,
          hoverOffset: 6,
          cutout: '62%'
        }]
      },
      options: {
        maintainAspectRatio: true,
        aspectRatio: 1.35,
        layout: { padding: 8 },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const pct = total ? Math.round((value / total) * 100) : 0;
                return `${label}: ${value} (${pct}%)`;
              }
            }
          },
          datalabels: {
            color: '#111',
            anchor: 'end',
            align: 'end',
            offset: 6,
            font: { weight: '600', size: 11 },
            formatter: (value) => value > 0 ? value : ''
          }
        }
      },
      plugins: [ChartDataLabels, centerText]
    });
  })();
</script>
{% endblock %}