{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-0">Welcome, {{ current_user.username }} ðŸ‘‹</h2>
    <p class="text-muted mb-0">Your marking overview and upcoming deadlines</p>
  </div>
</div>

<!-- Top row: Donut + Needs Marking -->
<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h5 class="mb-0">Workload Overview</h5>
      </div>
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div class="donut-wrap">
          <canvas id="workloadDonut" width="280" height="280" aria-label="Workload donut"></canvas>
          <div class="donut-center">
            <div class="center-number">{{ donut_data.total }}</div>
            <div class="center-label">Total</div>
          </div>
        </div>
        <div class="mt-3 w-100">
          <div class="d-flex flex-wrap gap-3 justify-content-center small">
            <span class="legend-dot legend-unsubmitted"></span> Unsubmitted ({{ donut_data.unsubmitted }})
            <span class="legend-dot legend-tomark"></span> To Mark ({{ donut_data.to_mark }})
            <span class="legend-dot legend-marked"></span> Marked ({{ donut_data.marked }})
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Needs Marking (soonest first) -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Needs Marking (soonest first)</h5>
        <small class="text-muted">Ordered by time remaining</small>
      </div>
      <div class="card-body p-0">
        {% if to_mark_list and to_mark_list|length > 0 %}
          <ul class="list-group list-group-flush">
            {% for it in to_mark_list %}
              <li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="me-3">
                  <div class="fw-semibold">
                    {{ it.student.username }} &middot; WB{{ it.wb }}
                  </div>
                  <div class="small text-muted">
                    Submitted {{ it.submission.submission_time.strftime('%Y-%m-%d %H:%M') }}
                    &middot; Deadline {{ it.deadline.strftime('%Y-%m-%d %H:%M') }}
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  {% set danger = (it.overdue or (it.days < 1 and it.hours <= 6)) %}
                  {% set warn = (not danger and it.days < 2) %}
                  {% if it.overdue %}
                    <span class="badge rounded-pill bg-danger">Overdue by {{ it.days }}d {{ it.hours }}h</span>
                  {% elif danger %}
                    <span class="badge rounded-pill bg-danger">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% elif warn %}
                    <span class="badge rounded-pill bg-warning text-dark">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% else %}
                    <span class="badge rounded-pill bg-success">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% endif %}
                  <a class="btn btn-sm btn-primary"
                     href="{{ url_for('mark_workbook_questions', submission_id=it.submission.id) }}">
                    Open
                  </a>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('marker_view_student', student_id=it.student.id) }}">
                    Student
                  </a>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="p-4 text-center text-muted">No unmarked submissions ðŸŽ‰</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Students by Cohort (ultra-sleek collapsible lists, no headers) -->
<div class="card shadow-sm mt-3">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h5 class="mb-0">Students by Cohort</h5>
    <small class="text-muted">Tap a cohort to expand</small>
  </div>
  <div class="card-body p-0">
    {% if students_overview and students_overview|length > 0 %}
      {% set rows = students_overview|sort(attribute='student.cohort.name') %}
      {% set current = None %}
      {% set group_index = 0 %}

      {% for r in rows %}
        {% set coh_name = r.student.cohort.name if r.student.cohort else 'â€”' %}
        {% if coh_name != current %}
          {# close previous cohort list #}
          {% if not loop.first %}
                </ul> <!-- .list-group -->
              </div> <!-- .collapse -->
            </div> <!-- .cohort-block -->
          {% endif %}

          {% set group_index = group_index + 1 %}
          {% set current = coh_name %}

          {# compute cohort totals for pill summary #}
          {% set _unsubmitted = 0 %}
          {% set _tomark = 0 %}
          {% set _marked = 0 %}
          {% set _total_slots = 0 %}
          {% for x in rows if (x.student.cohort.name if x.student.cohort else 'â€”') == coh_name %}
            {% set _unsubmitted = _unsubmitted + x.unsubmitted %}
            {% set _tomark = _tomark + x.to_mark %}
            {% set _marked = _marked + x.marked %}
            {% set _total_slots = _total_slots + x.required %}
          {% endfor %}

          <div class="cohort-block border-bottom">
            <button class="cohort-header w-100 d-flex align-items-center justify-content-between"
                    data-bs-toggle="collapse"
                    data-bs-target="#cohort-{{ group_index }}"
                    aria-expanded="true" aria-controls="cohort-{{ group_index }}">
              <div class="d-flex align-items-center gap-2">
                <span class="chev bi bi-chevron-down"></span>
                <span class="fw-semibold">{{ coh_name }}</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-secondary">Unsubmitted {{ _unsubmitted }}</span>
                <span class="badge bg-warning text-dark">To Mark {{ _tomark }}</span>
                <span class="badge bg-success">Marked {{ _marked }}</span>
                <span class="badge bg-light text-muted border">Total {{ _total_slots }}</span>
              </div>
            </button>

            <div id="cohort-{{ group_index }}" class="collapse show">
              <ul class="list-group list-group-flush">
        {% endif %}

                <li class="list-group-item d-flex align-items-center justify-content-between">
                  <div class="me-2">
                    <div class="fw-semibold">{{ r.student.username }}</div>
                    <div class="small text-muted">{{ r.student.course or 'â€”' }}</div>
                  </div>
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="chip chip-muted">{{ r.unsubmitted }}</span>
                    <span class="chip chip-warn">{{ r.to_mark }}</span>
                    <span class="chip chip-ok">{{ r.marked }}</span>
                    <span class="chip chip-total">{{ r.required }}</span>
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('marker_view_student', student_id=r.student.id) }}">
                      View
                    </a>
                  </div>
                </li>

        {% if loop.last %}
              </ul>
            </div> <!-- .collapse -->
          </div> <!-- .cohort-block -->
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="p-4 text-center text-muted">No assigned students.</div>
    {% endif %}
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
(function(){
  const ctx = document.getElementById('workloadDonut');
  if(!ctx) return;

  const cUnsubmitted = 'rgba(108, 117, 125, 0.85)'; // secondary grey
  const cToMark     = 'rgba(255, 193, 7, 0.9)';     // amber
  const cMarked     = 'rgba(76, 175, 80, 0.9)';     // NWMS green

  const donut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Unsubmitted', 'To Mark', 'Marked'],
      datasets: [{
        data: [
          {{ donut_data.unsubmitted|default(0) }},
          {{ donut_data.to_mark|default(0) }},
          {{ donut_data.marked|default(0) }}
        ],
        backgroundColor: [cUnsubmitted, cToMark, cMarked],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '68%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed || 0;
              const total = {{ donut_data.total|default(0) }};
              const pct = total ? Math.round((v / total) * 100) : 0;
              return `${ctx.label}: ${v} (${pct}%)`;
            }
          }
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true,
        duration: 900,
        easing: 'easeOutQuart'
      }
    }
  });

  const center = document.querySelector('.donut-center .center-number');
  if (center) {
    center.textContent = {{ donut_data.total|default(0) }};
  }

  // Cohort header chevron toggle
  document.querySelectorAll('.cohort-header').forEach(btn => {
    const chev = btn.querySelector('.chev');
    const targetSel = btn.getAttribute('data-bs-target');
    const el = document.querySelector(targetSel);
    if (!chev || !el) return;

    const update = () => {
      if (el.classList.contains('show')) {
        chev.classList.remove('bi-chevron-right');
        chev.classList.add('bi-chevron-down');
      } else {
        chev.classList.remove('bi-chevron-down');
        chev.classList.add('bi-chevron-right');
      }
    };
    update();
    el.addEventListener('shown.bs.collapse', update);
    el.addEventListener('hidden.bs.collapse', update);
  });
})();
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
/* Donut */
.donut-wrap{
  position: relative;
  width: 280px;
  height: 280px;
}
.donut-wrap canvas{
  width: 100% !important;
  height: 100% !important;
}
.donut-center{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  text-align: center;
  pointer-events: none;
}
.center-number{ font-size: 1.75rem; font-weight: 800; color: #2E7D32; }
.center-label{ font-size: .8rem; color: #6c757d; margin-top: .25rem; }

/* Legends */
.legend-dot{
  display:inline-block; width:10px; height:10px; border-radius:50%;
  margin-right:.35rem; position:relative; top:1px;
}
.legend-unsubmitted{ background: rgba(108,117,125,.85); }
.legend-tomark{ background: rgba(255,193,7,.9); }
.legend-marked{ background: rgba(76,175,80,.9); }

/* Cohort blocks (sleek lists) */
.cohort-block .cohort-header{
  background:#fff; border:0; padding:.85rem 1rem; cursor:pointer;
}
.cohort-block .cohort-header:hover{ background:#f7f7f8; }
.cohort-block .cohort-header .chev{
  font-size:1rem; color:#6c757d; transition:transform .2s ease;
}
.list-group-item{ padding:.7rem 1rem; }

/* Compact value chips */
.chip{
  display:inline-block; min-width:28px; text-align:center;
  padding:.25rem .5rem; border-radius:999px; font-size:.8rem; font-weight:600;
}
.chip-muted{ background:#e9ecef; color:#495057; }
.chip-warn{ background:#ffe08a; color:#664d03; }
.chip-ok{ background:#c8f0cc; color:#1b5e20; }
.chip-total{ background:#f8f9fa; color:#6c757d; border:1px solid #e9ecef; }

/* Cards */
.card{ border-radius:12px; }
.card-header{ background:#fff; }
</style>
{% endblock %}