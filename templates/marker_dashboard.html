{% extends 'base.html' %}
{% block title %}Marker · Dashboard{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-1">Welcome, {{ current_user.username }}</h2>
    <div class="text-muted">Here’s your overview and what needs marking.</div>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('marker_students') }}" class="btn btn-outline-primary btn-sm">My Students</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-5">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Overview</h5>
          <small class="text-muted">Counts of students</small>
        </div>
        <div class="d-flex align-items-center justify-content-center" style="min-height:220px;">
          <canvas id="statusDonut" width="260" height="260" style="max-width:260px; max-height:260px;"></canvas>
        </div>
        <div class="d-flex justify-content-around text-center small mt-2">
          <div><span class="badge bg-secondary">&nbsp;</span> Unsubmitted</div>
          <div><span class="badge bg-warning text-dark">&nbsp;</span> To be Marked</div>
          <div><span class="badge bg-success">&nbsp;</span> Marked</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-7">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Pending to Mark</h5>
          <small class="text-muted">Ordered by least time remaining</small>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>WB#</th>
                <th>Submitted</th>
                <th>Latest File</th>
                <th>Time Left</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in pending %}
              {% set s = item.submission %}
              {% set latest_ts = item.latest_time %}
              {% set was_reupload = (s.corrected_submission_time is not none) %}
              <tr>
                <td>
                  <a href="{{ url_for('marker_view_student', student_id=item.student.id) }}" class="text-decoration-none fw-semibold">
                    {{ item.student.username }}
                  </a>
                  <div class="small text-muted">{{ item.student.course or '—' }}</div>
                </td>
                <td class="fw-semibold">{{ s.workbook_number }}</td>
                <td>
                  <div title="{{ s.submission_time }}"> {{ s.submission_time.strftime('%Y-%m-%d %H:%M') }} </div>
                  {% if was_reupload %}
                    <div class="small text-danger" title="{{ s.corrected_submission_time }}">Re-uploaded at {{ s.corrected_submission_time.strftime('%Y-%m-%d %H:%M') }}</div>
                  {% endif %}
                </td>
                <td>
                  {% if s.corrected_submission_path %}
                    <span class="badge bg-danger">Re-upload</span>
                  {% else %}
                    <span class="badge bg-secondary">Original</span>
                  {% endif %}
                </td>
                <td>
                  {% set tl = item.time_left %}
                  {% if tl.total_seconds() <= 0 %}
                    <span class="text-danger fw-semibold">Overdue</span>
                  {% else %}
                    <span>{{ (tl.days) }}d {{ (tl.seconds // 3600) }}h</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% set latest_file = s.corrected_submission_path or s.file_path %}
                  {% if latest_file and latest_file.lower().endswith('.pdf') %}
                    <a href="{{ url_for('mark_workbook_questions', submission_id=s.id) }}"
                       class="btn btn-sm btn-outline-success">Mark by Questions</a>
                  {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled title="PDF required">Mark by Questions</button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% if pending|length == 0 %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">Nothing to mark right now.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function(){
    const data = {
      labels: ['Unsubmitted', 'To be Marked', 'Marked'],
      datasets: [{
        data: [
          {{ status_counts.get('Unsubmitted', 0) }},
          {{ status_counts.get('To be Marked', 0) }},
          {{ status_counts.get('Marked', 0) }}
        ],
        borderWidth: 1
      }]
    };
    const ctx = document.getElementById('statusDonut');
    if (ctx) {
      new Chart(ctx, {
        type: 'doughnut',
        data,
        options: {
          responsive: false,
          cutout: '62%',
          plugins: {
            legend: { display: true, position: 'bottom' },
            tooltip: { enabled: true }
          }
        }
      });
    }
  })();
</script>
{% endblock %}