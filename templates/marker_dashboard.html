{% extends 'base.html' %}
{% block title %}Marker · Dashboard{% endblock %}

{% block content %}
<style>
  .welcome { font-weight: 700; }
  .mini { font-size:.85rem; color:#6c757d; }
  .table-sm td, .table-sm th { padding:.5rem .75rem; }
  .card h5 { font-weight:600; }
  .chart-wrap { height:220px; } /* prevents canvas growth */
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="welcome mb-0">Welcome, {{ current_user.username }}</h2>
    <div class="text-muted small">Your assigned students and current marking workload.</div>
  </div>
  <a href="{{ url_for('marker_students') }}" class="btn btn-outline-secondary btn-sm">View My Students</a>
</div>

<div class="row g-3">
  <!-- Donut: Workbooks Outstanding -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-2">Workbooks Outstanding</h5>
        <div class="chart-wrap">
          <canvas id="markerDonut"></canvas>
        </div>
        <div class="mini mt-2">
          <span class="me-3">Unsubmitted: <strong>{{ donut_data.unsubmitted }}</strong></span>
          <span class="me-3">To be Marked: <strong>{{ donut_data.to_mark }}</strong></span>
          <span>Marked: <strong>{{ donut_data.marked }}</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Cohort overview (grouped & summarized) -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-2">Cohort Overview</h5>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Cohort</th>
                <th>Course</th>
                <th class="text-center">Students</th>
                <th class="text-center">Total Slots</th>
                <th class="text-center">Unsubmitted</th>
                <th class="text-center">To Mark</th>
                <th class="text-center">Marked</th>
              </tr>
            </thead>
            <tbody>
              {# Sort by cohort name first so groupby works reliably #}
              {% for cohort_name, items in (students_overview
                                            | sort(attribute='student.cohort.name')
                                            | groupby('student.cohort.name')) %}
                {% set cname = cohort_name if cohort_name is not none else 'Unassigned' %}
                {% set first = items.list[0] if items.list|length > 0 else None %}
                {% set course_name = (first.student.course if first else '—') %}
                {% set student_count = items.list|length %}
                {% set total_required = items.list|sum(attribute='required') %}
                {% set total_unsubmitted = items.list|sum(attribute='unsubmitted') %}
                {% set total_to_mark = items.list|sum(attribute='to_mark') %}
                {% set total_marked = items.list|sum(attribute='marked') %}

                <tr>
                  <td class="fw-semibold">{{ cname }}</td>
                  <td>{{ course_name or '—' }}</td>
                  <td class="text-center">{{ student_count }}</td>
                  <td class="text-center">{{ total_required }}</td>
                  <td class="text-center">{{ total_unsubmitted }}</td>
                  <td class="text-center">
                    {% if total_to_mark > 0 %}
                      <span class="badge bg-warning text-dark">{{ total_to_mark }}</span>
                    {% else %}
                      <span class="text-muted">0</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ total_marked }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">No assigned students yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent activity (filtered to your students) -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Recent Submissions</h5>
          <div class="mini">Latest 10 by your students</div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Workbook</th>
                <th>Status</th>
                <th>When</th>
                <th class="text-end">Open</th>
              </tr>
            </thead>
            <tbody>
              {% for s in recent_submissions %}
                {% if users.get(s.student_id) %}
                <tr>
                  <td class="fw-semibold">{{ users[s.student_id].username }}</td>
                  <td>WB {{ s.workbook_number }}</td>
                  <td>
                    {% if s.marked %}
                      <span class="badge bg-success">Marked</span>
                    {% else %}
                      {% if s.corrected_submission_path %}
                        <span class="badge bg-warning text-dark">Reupload · To Mark</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Submitted · To Mark</span>
                      {% endif %}
                    {% endif %}
                  </td>
                  <td>
                    <span title="{{ s.submission_time }}">{{ s.submission_time.strftime('%Y-%m-%d %H:%M') }}</span>
                  </td>
                  <td class="text-end">
                    <a href="{{ url_for('marker_view_student', student_id=s.student_id) }}" class="btn btn-sm btn-outline-secondary">Open Student</a>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
              {% if recent_submissions|length == 0 %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">No recent submissions.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Build cohort breakdown object for donut tooltips -->
{% set _groups = students_overview | sort(attribute='student.cohort.name') | groupby('student.cohort.name') %}
<script>
  // Cohort breakdown per segment (computed server-side via Jinja)
  const donutBreakdown = {
    "Unsubmitted": {
      {% for cname, items in _groups %}
        "{{ cname if cname is not none else 'Unassigned' }}": {{ items.list | sum(attribute='unsubmitted') }}{{ "," if not loop.last }}
      {% endfor %}
    },
    "To be Marked": {
      {% for cname, items in _groups %}
        "{{ cname if cname is not none else 'Unassigned' }}": {{ items.list | sum(attribute='to_mark') }}{{ "," if not loop.last }}
      {% endfor %}
    },
    "Marked": {
      {% for cname, items in _groups %}
        "{{ cname if cname is not none else 'Unassigned' }}": {{ items.list | sum(attribute='marked') }}{{ "," if not loop.last }}
      {% endfor %}
    }
  };
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function(){
  const el = document.getElementById('markerDonut');
  if (!el) return;

  const data = {
    labels: ['Unsubmitted', 'To be Marked', 'Marked'],
    datasets: [{
      data: [{{ donut_data.unsubmitted }}, {{ donut_data.to_mark }}, {{ donut_data.marked }}]
    }]
  };

  new Chart(el, {
    type: 'doughnut',
    data,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '60%',
      animation: { duration: 600, easing: 'easeOutQuart' },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: function(ctx){
              const total = {{ donut_data.total }};
              const v = ctx.parsed;
              const pct = total ? Math.round((v/total)*100) : 0;
              return `${ctx.label}: ${v} (${pct}%)`;
            },
            afterBody: function(ctx){
              // Add cohort breakdown under the main label
              if (!ctx.length) return;
              const label = ctx[0].label;
              const breakdown = donutBreakdown[label] || {};
              const entries = Object.entries(breakdown).filter(([k, val]) => val > 0);
              if (!entries.length) return;
              // Return an array of strings to become lines in the tooltip body
              return entries.map(([k, val]) => `• ${k}: ${val}`);
            }
          }
        }
      }
    }
  });
})();
</script>
{% endblock %}