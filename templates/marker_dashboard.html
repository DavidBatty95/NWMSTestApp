{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-0">Welcome, {{ current_user.username }} ðŸ‘‹</h2>
    <p class="text-muted mb-0">Your marking overview and upcoming deadlines</p>
  </div>
</div>

<!-- Top row: Donut + Quick stats -->
<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h5 class="mb-0">Workload Overview</h5>
      </div>
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div class="donut-wrap">
          <canvas id="workloadDonut" width="280" height="280" aria-label="Workload donut"></canvas>
          <div class="donut-center">
            <div class="center-label">Workbook Overview</div>
          </div>
        </div>
        <div class="mt-3 w-100">
          <div class="d-flex flex-wrap gap-3 justify-content-center small">
            <span class="legend-dot legend-unsubmitted"></span> Unsubmitted ({{ donut_data.unsubmitted }})
            <span class="legend-dot legend-tomark"></span> To Mark ({{ donut_data.to_mark }})
            <span class="legend-dot legend-marked"></span> Marked ({{ donut_data.marked }})
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Needs Marking (soonest first) -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Needs Marking (soonest first)</h5>
        <small class="text-muted">Ordered by time remaining</small>
      </div>
      <div class="card-body p-0">
        {% if to_mark_list and to_mark_list|length > 0 %}
          <ul class="list-group list-group-flush">
            {% for it in to_mark_list %}
              <li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="me-3">
                  <div class="fw-semibold">
                    {{ it.student.username }} &middot; WB{{ it.wb }}
                  </div>
                  <div class="small text-muted">
                    Submitted {{ it.submission.submission_time.strftime('%Y-%m-%d %H:%M') }}
                    &middot; Deadline {{ it.deadline.strftime('%Y-%m-%d %H:%M') }}
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  {% set danger = (it.overdue or (it.days < 1 and it.hours <= 6)) %}
                  {% set warn = (not danger and it.days < 2) %}
                  {% if it.overdue %}
                    <span class="badge rounded-pill bg-danger">Overdue by {{ it.days }}d {{ it.hours }}h</span>
                  {% elif danger %}
                    <span class="badge rounded-pill bg-danger">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% elif warn %}
                    <span class="badge rounded-pill bg-warning text-dark">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% else %}
                    <span class="badge rounded-pill bg-success">Due in {{ it.days }}d {{ it.hours }}h</span>
                  {% endif %}
                  <a class="btn btn-sm btn-primary"
                     href="{{ url_for('mark_workbook_questions', submission_id=it.submission.id) }}">
                    Open
                  </a>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('marker_view_student', student_id=it.student.id) }}">
                    Student
                  </a>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="p-4 text-center text-muted">No unmarked submissions ðŸŽ‰</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Cohort summaries -->
<div class="card shadow-sm mt-3">
  <div class="card-header">
    <h5 class="mb-0">Students by Cohort</h5>
  </div>
  <div class="card-body p-0">
    {% if students_overview and students_overview|length > 0 %}
      <!-- Weâ€™ll sort by cohort name; handle None safely -->
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="min-width: 180px;">Cohort</th>
              <th style="min-width: 180px;">Student</th>
              <th class="text-center">Unsubmitted</th>
              <th class="text-center">To Mark</th>
              <th class="text-center">Marked</th>
              <th class="text-center">Total</th>
              <th class="text-end" style="min-width: 140px;">Actions</th>
            </tr>
          </thead>
          <tbody>
          {# group-by-like rendering: loop twice, first determine ordered cohort keys #}
          {% set rows = students_overview|sort(attribute='student.cohort.name') %}
          {% set current = None %}
          {% for r in rows %}
            {% set coh = r.student.cohort.name if r.student.cohort else 'â€”' %}
            {% if coh != current %}
              {% if not loop.first %}
                <tr class="table-group-divider"><td colspan="7"></td></tr>
              {% endif %}
              <tr class="table-secondary">
                <td colspan="7" class="fw-semibold">{{ coh }}</td>
              </tr>
              {% set current = coh %}
            {% endif %}
            <tr>
              <td class="text-muted">{{ coh }}</td>
              <td class="fw-semibold">{{ r.student.username }}</td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ r.unsubmitted }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-warning text-dark">{{ r.to_mark }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-success">{{ r.marked }}</span>
              </td>
              <td class="text-center">{{ r.required }}</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary"
                   href="{{ url_for('marker_view_student', student_id=r.student.id) }}">
                  View
                </a>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-4 text-center text-muted">No assigned students.</div>
    {% endif %}
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
(function(){
  const ctx = document.getElementById('workloadDonut');
  if(!ctx) return;

  // Brand-aligned colors
  const cUnsubmitted = 'rgba(108, 117, 125, 0.85)'; // secondary grey
  const cToMark     = 'rgba(255, 193, 7, 0.9)';     // warning amber
  const cMarked     = 'rgba(76, 175, 80, 0.9)';     // NWMS green

  const donut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Unsubmitted', 'To Mark', 'Marked'],
      datasets: [{
        data: [
          {{ donut_data.unsubmitted|default(0) }},
          {{ donut_data.to_mark|default(0) }},
          {{ donut_data.marked|default(0) }}
        ],
        backgroundColor: [cUnsubmitted, cToMark, cMarked],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '68%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed || 0;
              const total = {{ donut_data.total|default(0) }};
              const pct = total ? Math.round((v / total) * 100) : 0;
              return `${ctx.label}: ${v} (${pct}%)`;
            }
          }
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true,
        duration: 900,
        easing: 'easeOutQuart'
      }
    }
  });

  // Hover total in center
  const center = document.querySelector('.donut-center');
  if (center) {
    const total = {{ donut_data.total|default(0) }};
    center.querySelector('.center-number').textContent = total;
  }
})();
</script>

<style>
/* Centered donut container */
.donut-wrap{
  position: relative;
  width: 280px;
  height: 280px;
}
.donut-wrap canvas{
  width: 100% !important;
  height: 100% !important;
}
.donut-center{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  text-align: center;
  pointer-events: none;
}
.center-number{
  font-size: 1.75rem;
  font-weight: 800;
  line-height: 1;
  color: #2E7D32; /* deep green */
}
.center-label{
  font-size: .8rem;
  color: #6c757d;
  margin-top: .25rem;
}

/* Legends (inline dots) */
.legend-dot{
  display:inline-block;
  width: 10px; height:10px;
  border-radius: 50%;
  margin-right: .35rem;
  position: relative; top: 1px;
}
.legend-unsubmitted{ background: rgba(108,117,125,.85); }
.legend-tomark{ background: rgba(255,193,7,.9); }
.legend-marked{ background: rgba(76,175,80,.9); }

/* Tighten list */
.list-group-item{ padding-top: .7rem; padding-bottom: .7rem; }

/* Make cards feel airy but consistent with brand */
.card{ border-radius: 12px; }
.card-header{ background: #fff; }
</style>
{% endblock %}