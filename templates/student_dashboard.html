{% extends 'base.html' %}
{% block title %}Student · Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

{# --------- Quick counters for progress + percentages --------- #}
{% set ns = namespace(total=items|length, submitted=0, passed=0, failed=0) %}
{% for row in items %}
  {% set latest = row.latest %}
  {% if latest %}{% set ns.submitted = ns.submitted + 1 %}{% endif %}
  {% if row.label == 'Marked Pass' %}{% set ns.passed = ns.passed + 1 %}{% endif %}
  {% if row.label == 'Failed' %}{% set ns.failed = ns.failed + 1 %}{% endif %}
{% endfor %}
{% set unsubmitted = (ns.total - ns.submitted) if ns.total else 0 %}
{% set in_progress = (ns.submitted - ns.passed - ns.failed) if ns.total else 0 %}
{% set pct_pass = (ns.passed * 100 // (ns.total if ns.total else 1)) %}
{% set pct_submitted = (ns.submitted * 100 // (ns.total if ns.total else 1)) %}

{# --------- Dates / countdown --------- #}
{% set _start = course_start_date %}
{% set _deadline = course_deadline %}
{% set _start_iso = _start.strftime('%Y-%m-%dT%H:%M:%SZ') if _start else '' %}
{% set _deadline_iso = _deadline.strftime('%Y-%m-%dT%H:%M:%SZ') if _deadline else '' %}
{% set _start_human = _start.strftime('%d %b %Y') if _start else '—' %}
{% set _deadline_human = _deadline.strftime('%d %b %Y') if _deadline else '—' %}

<style>
  :root{
    --nwms-green:#4CAF50;
    --nwms-green-2:#2E7D32;
    --amber:#F6C453;
    --muted:#6c757d;
  }
  .panel { border-radius: 14px; border:1px solid #e9ecef; box-shadow:0 4px 14px rgba(0,0,0,.06); background:#fff; }
  .panel-head { padding:16px 18px; border-bottom:1px solid #eef0f2; }

  /* Prominent status panel with coloured top bar */
  .status-panel { position:relative; overflow:hidden; }
  .status-panel::before{
    content:""; position:absolute; inset:0 0 auto 0; height:6px;
    background: var(--bar-color, var(--nwms-green));
  }
  .status-body { padding:18px; display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
  .status-icon{
    width:56px; height:56px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:1.5rem; box-shadow:0 6px 16px rgba(0,0,0,.18);
    background:#fff;
  }
  .status-meta .lead { font-weight:700; margin:0; }
  .status-meta .sub { color:var(--muted); font-size:.95rem; }

  /* Progress block (matches panels) */
  .progress-panel .panel-body{ padding:18px; }
  .progress { height: 14px; border-radius: 999px; background:#f1f3f5; }
  .progress .progress-bar { font-size:.75rem; font-weight:600; }
  .progress-caption { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
  .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #e9ecef; padding:.25rem .6rem; border-radius:999px; background:#fff; font-weight:600; font-size:.85rem; }

  /* Countdown colors */
  .countdown-ok { color: #198754; font-weight: 700; }
  .countdown-warn { color: #d68910; font-weight: 700; }
  .countdown-bad { color: #dc3545; font-weight: 700; }

  /* Table tweaks */
  .table td, .table th { vertical-align: middle; }
  .table .badge { font-weight: 600; }
  .upload-group { min-width: 280px; }
  @media (max-width: 768px){ .upload-group{ min-width:100%; } }
</style>

{# ================= Welcome / meta ================= #}
<div id="courseMeta" class="panel mb-3" data-deadline="{{ _deadline_iso }}">
  <div class="panel-head">
    <h2 class="mb-0">Welcome, {{ current_user.username }}!</h2>
  </div>
  <div class="p-3">
    <div class="text-muted">
      Course: <strong>{{ current_user.course or '—' }}</strong>
      &nbsp;&middot;&nbsp;
      Start: <strong>{{ _start_human }}</strong>
      &nbsp;&middot;&nbsp;
      Allowed: <strong>{{ months_allowed }} months</strong>
    </div>
    <div class="mt-1">
      <span class="text-muted">Time remaining:</span>
      <span id="deadlineCountdown" class="fw-semibold ms-1">—</span>
      <span class="text-muted small">(Deadline: {{ _deadline_human }})</span>
    </div>
  </div>
</div>

{# ================= Overall status (with coloured top bar) ================= #}
{% set status_color = '#6c757d' %}
{% set status_icon = 'bi-hourglass-split' %}
{% set status_title = 'In Progress' %}
{% if overall_status == 'Pass' %}
  {% set status_color = '#4CAF50' %}
  {% set status_icon = 'bi-check-circle-fill' %}
  {% set status_title = 'Pass' %}
{% elif overall_status == 'Fail' %}
  {% set status_color = '#dc3545' %}
  {% set status_icon = 'bi-x-circle-fill' %}
  {% set status_title = 'Fail' %}
{% endif %}

<div class="panel status-panel mb-3" style="--bar-color: {{ status_color }}">
  <div class="status-body">
    <div class="status-icon" style="color: {{ status_color }}">
      <i class="bi {{ status_icon }}"></i>
    </div>
    <div class="status-meta me-auto">
      <div class="lead" style="color: {{ status_color }};">Overall Status: {{ status_title }}</div>
      <div class="sub">
        {{ ns.passed }} of {{ ns.total }} workbooks passed &middot; {{ ns.submitted }} submitted &middot; {{ unsubmitted }} remaining
      </div>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="chip"><i class="bi bi-check2-circle text-success"></i> {{ ns.passed }} Passed</span>
      <span class="chip"><i class="bi bi-hourglass-split text-warning"></i> {{ in_progress }} In progress</span>
      <span class="chip"><i class="bi bi-cloud-arrow-up text-secondary"></i> {{ unsubmitted }} Unsubmitted</span>
    </div>
  </div>

  {# ====== Integrated progress bar ====== #}
  <div class="px-3 pb-3">
    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"
         aria-valuenow="{{ pct_pass }}">
      {% set pass_pct = (ns.passed * 100 // (ns.total if ns.total else 1)) %}
      {% set prog_pct = (in_progress * 100 // (ns.total if ns.total else 1)) %}
      {% set unsub_pct = (unsubmitted * 100 // (ns.total if ns.total else 1)) %}
      {% if pass_pct > 0 %}
        <div class="progress-bar bg-success" style="width: {{ pass_pct }}%"></div>
      {% endif %}
      {% if prog_pct > 0 %}
        <div class="progress-bar bg-warning text-dark" style="width: {{ prog_pct }}%"></div>
      {% endif %}
      {% if unsub_pct > 0 %}
        <div class="progress-bar bg-secondary" style="width: {{ unsub_pct }}%"></div>
      {% endif %}
    </div>
  </div>
</div>

{# ================= Workbooks ================= #}
<div class="panel">
  <div class="panel-head d-flex align-items-center justify-content-between">
    <h5 class="mb-0">Your Workbooks</h5>
    <div class="small text-muted">Max {{ MAX_ATTEMPTS }} attempts per workbook</div>
  </div>
  <div class="p-3">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="min-width: 120px;">Workbook</th>
            <th>Status</th>
            <th class="text-center" style="width:120px;">Attempts Left</th>
            <th>Last Submitted</th>
            <th>Marker Feedback</th>
            <th class="text-end" style="min-width: 460px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in items %}
            {% set latest = row.latest %}
            {% set nsrow = namespace(label=row.label, badge=row.badge) %}
            {# If out of attempts and not passed, call it Failed #}
            {% if latest and latest.marked and row.attempts_left == 0 and (latest.is_referral or (latest.score is not none and latest.score == 0)) %}
              {% set nsrow.label = 'Failed' %}
              {% set nsrow.badge = 'bg-dark text-white' %}
            {% endif %}

            <tr data-wb="{{ row.wb_number }}" data-status="{{ nsrow.label|lower }}">
              <td class="fw-semibold">Workbook {{ row.wb_number }}</td>

              <td>
                <span class="badge {{ nsrow.badge }}">
                  {{ nsrow.label }}
                </span>
              </td>

              <td class="text-center">
                {% if row.attempts_so_far == 0 %}
                  <span class="text-muted">—</span>
                {% else %}
                  <span class="fw-semibold">{{ row.attempts_left }}</span>
                {% endif %}
              </td>

              <td>
                {% if latest %}
                  <span title="{{ latest.submission_time }}">
                    {{ latest.submission_time.strftime('%Y-%m-%d %H:%M') }}
                  </span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td>
                {% if latest and latest.feedback %}
                  <span class="small">{{ latest.feedback }}</span>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>

              <td class="text-end">
                <div class="d-flex flex-wrap justify-content-end align-items-center gap-2">
                  {% if row.can_upload %}
                    <!-- First submission -->
                    <form action="{{ url_for('student_dashboard') }}" method="post" enctype="multipart/form-data"
                          class="d-flex flex-wrap align-items-center gap-2">
                      <input type="hidden" name="workbook_number" value="{{ row.wb_number }}">
                      <div class="input-group input-group-sm upload-group">
                        <input type="file" name="file" class="form-control" accept="application/pdf" required>
                        <button type="submit" class="btn btn-primary">Upload</button>
                      </div>
                    </form>

                  {% elif row.can_reattempt %}
                    <!-- Reattempt after referral -->
                    <form action="{{ url_for('student_dashboard') }}" method="post" enctype="multipart/form-data"
                          class="d-flex flex-wrap align-items-center gap-2">
                      <input type="hidden" name="workbook_number" value="{{ row.wb_number }}">
                      <div class="input-group input-group-sm upload-group">
                        <input type="file" name="referral_file" class="form-control" accept="application/pdf" required>
                        <button type="submit" class="btn btn-danger">Re-upload</button>
                      </div>
                      {% if latest and latest.marked %}
                        <a class="btn btn-outline-secondary btn-sm"
                           href="{{ url_for('student_view_feedback', workbook_number=row.wb_number) }}">
                          View feedback
                        </a>
                      {% endif %}
                    </form>

                  {% else %}
                    {% if latest and latest.marked %}
                      <a class="btn btn-outline-secondary btn-sm"
                         href="{{ url_for('student_view_feedback', workbook_number=row.wb_number) }}">
                        View feedback
                      </a>
                    {% else %}
                      <span class="text-muted small">No action available</span>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}

          {% if items|length == 0 %}
            <tr><td colspan="6" class="text-center text-muted py-4">No workbooks for your course.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Legend -->
    <div class="mt-3 small d-flex flex-wrap align-items-center gap-2">
      <span class="badge bg-success">Marked Pass</span>
      <span class="badge bg-secondary">Awaiting submission</span>
      <span class="badge bg-warning text-dark">Submitted</span>
      <span class="badge bg-danger">Waiting for reattempt</span>
      <span class="badge bg-dark text-white">Failed</span>
    </div>
  </div>
</div>

<script>
/* -------- Deadline countdown -------- */
(function(){
  const meta = document.getElementById('courseMeta');
  const targetEl = document.getElementById('deadlineCountdown');
  if(!meta || !targetEl) return;

  const deadlineISO = meta.dataset.deadline;
  if(!deadlineISO){
    targetEl.textContent = 'Deadline not set';
    return;
  }
  const deadline = new Date(deadlineISO);

  function paintClass(days){
    targetEl.classList.remove('countdown-ok','countdown-warn','countdown-bad');
    if (days <= 14)      targetEl.classList.add('countdown-bad');
    else if (days <= 60) targetEl.classList.add('countdown-warn');
    else                 targetEl.classList.add('countdown-ok');
  }

  function updateCountdown(){
    const now = new Date();
    const diffMs = deadline - now;

    if (diffMs <= 0){
      targetEl.textContent = '0d 0h 0m';
      paintClass(0);
      return;
    }

    const minutes = Math.floor(diffMs / 60000);
    const days = Math.floor(minutes / (60*24));
    const hours = Math.floor((minutes - days*60*24) / 60);
    const mins = minutes % 60;

    targetEl.textContent = `${days}d ${hours}h ${mins}m`;
    paintClass(days);
  }

  updateCountdown();
  setInterval(updateCountdown, 60 * 1000);
})();

/* ---------- Reliable confetti celebration (no deps, once per WB) ---------- */
document.addEventListener('DOMContentLoaded', function () {
  if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  const userId = {{ current_user.id|int }};
  const rows = Array.from(document.querySelectorAll('tbody tr[data-wb]'));
  if (!rows.length) return;

  const toCelebrate = [];
  rows.forEach(tr => {
    const wb = parseInt(tr.getAttribute('data-wb'), 10);
    if (!wb) return;

    const statusBadge = tr.querySelector('td:nth-child(2) .badge');
    const isSuccess = statusBadge?.classList?.contains('bg-success');

    const text = (tr.getAttribute('data-status') || statusBadge?.textContent || '').trim().toLowerCase();
    const looksPass = /pass/.test(text) && !/fail/.test(text);

    const passed = !!(isSuccess || looksPass);
    if (!passed) return;

    const key = `confetti:v1:user:${userId}:wb:${wb}`;
    if (!localStorage.getItem(key)) {
      toCelebrate.push(key);
    }
  });

  if (!toCelebrate.length) return;
  toCelebrate.forEach(key => localStorage.setItem(key, '1'));

  const canvas = document.createElement('canvas');
  canvas.style.position = 'fixed';
  canvas.style.inset = '0';
  canvas.style.zIndex = '2147483647';
  canvas.style.pointerEvents = 'none';
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  resize();
  window.addEventListener('resize', resize, { passive: true });

  const colors = ['#4caf50','#81c784','#66bb6a','#43a047','#2e7d32','#a5d6a7','#c8e6c9'];
  const area = Math.max(1, window.innerWidth * window.innerHeight);
  const N = Math.min(320, Math.max(160, Math.floor(area / 16000)));
  const particles = [];

  function rand(min, max) { return min + Math.random() * (max - min); }

  for (let i = 0; i < N; i++) {
    particles.push({
      x: rand(0, window.innerWidth),
      y: rand(-40, -window.innerHeight * 0.3),
      vx: rand(-1.2, 1.2),
      vy: rand(1.8, 3.8),
      size: rand(2, 5),
      rot: rand(0, Math.PI * 2),
      vr: rand(-0.25, 0.25),
      shape: Math.random() < 0.6 ? 'rect' : 'circ',
      color: colors[(Math.random() * colors.length) | 0],
    });
  }

  const start = performance.now();
  const duration = 2000;
  const wind = rand(-0.04, 0.04);
  const gravity = 0.02;

  (function tick(now) {
    const t = now - start;
    ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

    particles.forEach(p => {
      p.vx += wind * 0.02;
      p.vy += gravity;

      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      if (p.shape === 'rect') {
        ctx.fillRect(-p.size, -p.size, p.size * 2, p.size * 2);
      } else {
        ctx.beginPath();
        ctx.arc(0, 0, p.size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();
    });

    if (t < duration) {
      requestAnimationFrame(tick);
    } else {
      window.removeEventListener('resize', resize);
      canvas.remove();
    }
  })(start);
});
</script>
{% endblock %}