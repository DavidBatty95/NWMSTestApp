{% extends 'base.html' %}
{% block title %}Student · Dashboard{% endblock %}

{% block content %}
<h2 class="mb-1">My Workbooks</h2>
<p class="text-muted">Submit your workbooks and track feedback & attempts.</p>

<!-- Overall status card -->
<div class="mb-4">
  {% if overall_status == 'Pass' %}
    <div class="status-card bg-success text-white shadow-sm">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h5 class="mb-1">Overall Status</h5>
          <p class="mb-0 fw-bold fs-5">Pass</p>
        </div>
        <div class="status-icon bg-white text-success">
          <i class="bi bi-check-circle-fill"></i>
        </div>
      </div>
    </div>
  {% elif overall_status == 'Fail' %}
    <div class="status-card bg-danger text-white shadow-sm">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h5 class="mb-1">Overall Status</h5>
          <p class="mb-0 fw-bold fs-5">Fail</p>
        </div>
        <div class="status-icon bg-white text-danger">
          <i class="bi bi-x-circle-fill"></i>
        </div>
      </div>
    </div>
  {% else %}
    <div class="status-card bg-warning text-dark shadow-sm">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h5 class="mb-1">Overall Status</h5>
          <p class="mb-0 fw-bold fs-5">In Progress</p>
        </div>
        <div class="status-icon bg-dark text-warning">
          <i class="bi bi-hourglass-split"></i>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="min-width: 120px;">Workbook</th>
            <th>Status</th>
            <th class="text-center" style="width:120px;">Attempts Left</th>
            <th>Last Submitted</th>
            <th>Marker Feedback</th>
            <th class="text-end" style="min-width: 260px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for row in items %}
          <tr>
            <td class="fw-semibold">Workbook {{ row.wb_number }}</td>

            <!-- Status badge -->
            <td><span class="badge {{ row.badge }}">{{ row.label }}</span></td>

            <!-- Attempts left (single number) -->
            <td class="text-center">
              {% if row.attempts_so_far == 0 %}
                <span class="text-muted">—</span>
              {% else %}
                <span class="fw-semibold">{{ row.attempts_left }}</span>
              {% endif %}
            </td>

            <!-- Last submitted -->
            <td>
              {% if row.latest %}
                <span title="{{ row.latest.submission_time }}">
                  {{ row.latest.submission_time.strftime('%Y-%m-%d %H:%M') }}
                </span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <!-- Feedback -->
            <td>
              {% if row.latest and row.latest.feedback %}
                <span class="small">{{ row.latest.feedback }}</span>
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td class="text-end">
              {% if row.can_upload %}
                <!-- First submission -->
                <form action="{{ url_for('student_dashboard') }}" method="post" enctype="multipart/form-data" class="d-inline-flex align-items-center gap-2">
                  <input type="hidden" name="workbook_number" value="{{ row.wb_number }}">
                  <input type="file" name="file" class="form-control form-control-sm" required>
                  <button type="submit" class="btn btn-sm btn-primary">Upload</button>
                </form>

              {% elif row.can_reattempt %}
                <!-- Reattempt after referral -->
                <div class="mb-1 small">
                  Attempts left: <span class="fw-semibold">{{ row.attempts_left }}</span>
                </div>
                <form action="{{ url_for('student_dashboard') }}" method="post" enctype="multipart/form-data" class="d-inline-flex align-items-center gap-2">
                  <input type="hidden" name="workbook_number" value="{{ row.wb_number }}">
                  <input type="file" name="referral_file" class="form-control form-control-sm" required>
                  <button type="submit" class="btn btn-sm btn-danger">Re-upload</button>
                </form>
                {% if row.latest and row.latest.corrected_submission_path %}
                  <div class="small text-muted mt-1">Reattempt uploaded: {{ row.latest.corrected_submission_path }}</div>
                {% endif %}

              {% else %}
                <span class="text-muted small">No action available</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          {% if items|length == 0 %}
            <tr><td colspan="6" class="text-center text-muted py-4">No workbooks for your course.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Legend -->
<div class="mt-3 small">
  <span class="badge bg-success">Marked Pass</span>
  <span class="badge bg-secondary">Awaiting submission</span>
  <span class="badge bg-warning text-dark">Submitted</span>
  <span class="badge bg-danger">Waiting for reattempt</span>
  <span class="ms-2 text-muted">Max 3 attempts per workbook.</span>
</div>

<!-- Status card styles & icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  .status-card {
    border-radius: 14px;
    padding: 16px 20px;
  }
  .status-icon {
    width: 50px; height: 50px;
    display:flex; align-items:center; justify-content:center;
    border-radius: 50%;
    font-size: 1.5rem;
    box-shadow: 0 4px 10px rgba(0,0,0,.2);
  }
</style>
{% endblock %}