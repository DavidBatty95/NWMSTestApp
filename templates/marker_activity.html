{% extends "base.html" %}
{% block title %}Marker · Activity Feed{% endblock %}

{% block content %}
<style>
  .page-head{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1rem}
  .page-head h2{margin:0;font-weight:600}
  .muted{color:#6c757d}
  .chip{display:inline-block;padding:.35rem .6rem;border:1px solid #e9ecef;border-radius:999px;background:#fff;font-weight:600;font-size:.85rem}
  .toolbar{position:sticky;top:16px;z-index:9}
  .table-sm td,.table-sm th{padding:.5rem .6rem;vertical-align:middle}
  .nowrap{white-space:nowrap}
  .actions .btn{padding:.25rem .5rem}
  .icon{width:1rem;height:1rem;vertical-align:middle}
</style>

{# ---- quick counts (template-only; no Python needed) ---- #}
{% set total = submissions|length if submissions else 0 %}
{% set ns = namespace(awaiting=0, referral=0, pass=0, fail=0) %}
{% for s in submissions or [] %}
  {% if not s.marked %}
    {% set ns.awaiting = ns.awaiting + 1 %}
  {% elif s.is_referral %}
    {% set ns.referral = ns.referral + 1 %}
  {% elif s.score == 0 %}
    {% set ns.fail = ns.fail + 1 %}
  {% else %}
    {% set ns.pass = ns.pass + 1 %}
  {% endif %}
{% endfor %}

<div class="page-head">
  <div>
    <h2>Recent Activity</h2>
    <div class="muted">Latest workbook submissions across your assigned students.</div>
  </div>
  <a href="{{ url_for('marker_dashboard') }}" class="btn btn-light btn-sm">← Dashboard</a>
</div>

<!-- Sticky filters/search + quick stats -->
<div class="toolbar mb-3">
  <div class="card shadow-sm">
    <div class="card-body py-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label mb-1">Search</label>
          <input id="searchInput" type="text" class="form-control" placeholder="Search student, course, workbook, status…">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Course</label>
          {# Build a unique course list from the data #}
          {% set seen = [] %}
          <select id="filterCourse" class="form-select">
            <option value="">All courses</option>
            {% for s in submissions or [] %}
              {% if s.student.course and (s.student.course not in seen) %}
                {% set _ = seen.append(s.student.course) %}
                <option value="{{ s.student.course }}">{{ s.student.course }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Status</label>
          <select id="filterStatus" class="form-select">
            <option value="">All</option>
            <option value="awaiting">Awaiting Marking</option>
            <option value="pass">Pass</option>
            <option value="referral">Referral</option>
            <option value="fail">Fail</option>
          </select>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <span class="chip">Total: {{ total }}</span>
        <span class="chip">Awaiting: {{ ns.awaiting }}</span>
        <span class="chip">Pass: {{ ns.pass }}</span>
        <span class="chip">Referral: {{ ns.referral }}</span>
        <span class="chip">Fail: {{ ns.fail }}</span>
      </div>
    </div>
  </div>
</div>

{% if submissions %}
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0" id="feedTable">
        <thead class="table-light sticky-top">
          <tr>
            <th>Student</th>
            <th>Course</th>
            <th>Workbook</th>
            <th class="nowrap">Submitted</th>
            <th>File</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in submissions %}
          {% set course = s.student.course or '—' %}
          {% set status_key = ('awaiting' if not s.marked else ('referral' if s.is_referral else ('fail' if s.score == 0 else 'pass'))) %}
          <tr
            data-student="{{ (s.student.username or '')|lower }}"
            data-course="{{ course|lower }}"
            data-wb="{{ s.workbook_number }}"
            data-status="{{ status_key }}"
          >
            <td class="fw-semibold">{{ s.student.username }}</td>
            <td>{{ course }}</td>
            <td>Workbook {{ s.workbook_number }}</td>
            <td class="nowrap" title="{{ s.submission_time.strftime('%a %d %b %Y, %H:%M') }}">
              {{ s.submission_time.strftime('%Y-%m-%d %H:%M') }}
            </td>
            <td>
              {% set pdf_path = s.corrected_submission_path or s.file_path %}
              {% if pdf_path %}
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('uploaded_file', filename=pdf_path) }}" target="_blank" rel="noopener"
                   data-bs-toggle="tooltip" data-bs-title="Open PDF">
                  Preview
                </a>
              {% else %}—{% endif %}
            </td>
            <td>
              {% if not s.marked %}
                <span class="badge bg-secondary">Awaiting Marking</span>
              {% elif s.is_referral %}
                <span class="badge bg-warning text-dark">Referral</span>
              {% elif s.score == 0 %}
                <span class="badge bg-danger">Fail</span>
              {% else %}
                <span class="badge bg-success">Pass</span>
              {% endif %}
            </td>
            <td class="text-end actions">
              <div class="btn-group">
                {% if not s.marked %}
                  <a class="btn btn-success btn-sm" href="{{ url_for('mark_workbook_questions', submission_id=s.id) }}" data-bs-toggle="tooltip" data-bs-title="Mark now">Mark</a>
                {% else %}
                  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('marker_view_student', student_id=s.student_id) }}" data-bs-toggle="tooltip" data-bs-title="View student">View</a>
                {% endif %}
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('marker_view_student', student_id=s.student_id) }}#wb{{ s.workbook_number }}"
                   data-bs-toggle="tooltip" data-bs-title="Go to workbook on student page">Jump</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="alert alert-info mt-3">No recent submissions to display.</div>
{% endif %}

<script>
  // Enable Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  });

  // Simple client-side filter/search
  (function(){
    const q  = document.getElementById('searchInput');
    const fc = document.getElementById('filterCourse');
    const fs = document.getElementById('filterStatus');
    const rows = Array.from(document.querySelectorAll('#feedTable tbody tr'));
    const norm = s => (s||'').toString().trim().toLowerCase();

    function apply(){
      const qq = norm(q.value);
      const course = norm(fc.value);
      const status = norm(fs.value);

      rows.forEach(tr => {
        const hay = (tr.innerText || '').toLowerCase();
        const ok =
          (!qq || hay.includes(qq)) &&
          (!course || tr.dataset.course === course) &&
          (!status || tr.dataset.status === status);
        tr.style.display = ok ? '' : 'none';
      });
    }

    [q, fc, fs].forEach(el => { el && el.addEventListener('input', apply); el && el.addEventListener('change', apply); });
  })();
</script>
{% endblock %}