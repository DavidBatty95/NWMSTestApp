{% extends 'base.html' %}
{% block title %}Admin Â· Dashboard{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-1">Admin Dashboard</h2>
    <p class="text-muted mb-0">Overview of cohorts, students, and marking activity.</p>
  </div>
</div>

<div class="row g-3">
  <!-- KPI cards -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small">Students</div>
        <div class="display-6 fw-semibold">{{ students|length }}</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small">Markers</div>
        <div class="display-6 fw-semibold">{{ markers|length }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Assignments</div>
          <div class="h3 fw-semibold mb-0">{{ assignments|length }}</div>
        </div>
        <div class="text-end">
          <div class="small text-muted">Avg. students/marker</div>
          {% set mcount = (markers|length) if (markers|length) > 0 else 1 %}
          <div class="h4 fw-semibold mb-0">
            {{ (assignments|length / mcount)|round(1) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status donut + Legend -->
<div class="row g-3 mt-1">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Student Status</h5>
        </div>
        <div class="position-relative mx-auto" style="max-width: 420px;">
          <canvas id="statusDonut" width="420" height="420" style="width:100%;height:auto;"></canvas>
        </div>

        <!-- Legend -->
        <div class="d-flex flex-wrap gap-2 justify-content-center mt-3">
          <!-- Colors must match the dataset below -->
          <span class="badge rounded-pill legend-pill" style="background:#aeb4ba;">Unsubmitted</span>
          <span class="badge rounded-pill legend-pill" style="background:#f6c453; color:#1f2328;">Awaiting Marking</span>
          <span class="badge rounded-pill legend-pill" style="background:#e57373;">Referral</span>
          <span class="badge rounded-pill legend-pill" style="background:#4caf50;">Passed</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent activity -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Recent Submissions</h5>
          <a href="{{ url_for('admin_activity') }}" class="btn btn-sm btn-outline-secondary">Activity Log</a>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th class="text-center">WB</th>
                <th>Submitted</th>
                <th class="text-end">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for s in recent_submissions %}
              {% set u = users.get(s.student_id) if users is defined else None %}
              <tr>
                <td>{{ (u.username if u else 'Student #' ~ s.student_id) }}</td>
                <td class="text-center">#{{ s.workbook_number }}</td>
                <td>
                  <span title="{{ s.submission_time }}">
                    {{ s.submission_time.strftime('%Y-%m-%d %H:%M') }}
                  </span>
                </td>
                <td class="text-end">
                  {% if not s.marked %}
                    <span class="badge bg-warning text-dark">Awaiting Marking</span>
                  {% elif s.is_referral %}
                    <span class="badge bg-danger">Referral</span>
                  {% elif s.score == 0 %}
                    <span class="badge bg-dark">Failed</span>
                  {% else %}
                    <span class="badge bg-success">Passed</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% if recent_submissions|length == 0 %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3">No recent submissions.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .legend-pill{font-weight:600; letter-spacing:.2px;}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
(function(){
  const dataCounts = {
    unsubmitted: {{ status_counts["Unsubmitted"]|default(0) }},
    awaiting:    {{ status_counts["Awaiting Marking"]|default(0) }},
    referral:    {{ status_counts["Referral"]|default(0) }},
    passed:      {{ status_counts["Passed"]|default(0) }}
  };
  const total = dataCounts.unsubmitted + dataCounts.awaiting + dataCounts.referral + dataCounts.passed;

  // Brand-aligned palette (soft, professional)
  const COLORS = {
    unsubmitted: '#AEB4BA',   // muted grey
    awaiting:    '#F6C453',   // warm amber
    referral:    '#E57373',   // soft red
    passed:      '#4CAF50'    // NWMS green
  };

  // Center label plugin
  const centerLabel = {
    id: 'centerLabel',
    afterDraw(chart, args, opts){
      const {ctx, chartArea: {width, height}} = chart;
      const meta = chart.getDatasetMeta(0);
      if (!meta || !meta.data || !meta.data.length) return;

      ctx.save();
      const x = chart.getDatasetMeta(0).data[0].x;
      const y = chart.getDatasetMeta(0).data[0].y;

      // Outer total
      ctx.fillStyle = '#1f2328';
      ctx.font = '700 22px system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(total.toString(), x, y - 4);

      // Subtext
      ctx.fillStyle = '#6c757d';
      ctx.font = '500 11px system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial';
      ctx.fillText('Students', x, y + 14);

      ctx.restore();
    }
  };

  const ctx = document.getElementById('statusDonut').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Unsubmitted', 'Awaiting Marking', 'Referral', 'Passed'],
      datasets: [{
        data: [
          dataCounts.unsubmitted,
          dataCounts.awaiting,
          dataCounts.referral,
          dataCounts.passed
        ],
        backgroundColor: [
          COLORS.unsubmitted,
          COLORS.awaiting,
          COLORS.referral,
          COLORS.passed
        ],
        borderWidth: 0,
        hoverOffset: 8,
        cutout: '64%'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(18,19,21,.92)',
          padding: 10,
          bodyFont: { weight: 600 },
          displayColors: true,
          callbacks: {
            label: function(ctx){
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const pct = total ? Math.round((value / total) * 100) : 0;
              return ` ${label}: ${value} (${pct}%)`;
            }
          }
        }
      },
      animation: {
        duration: 900,
        easing: 'easeOutQuart'
      }
    },
    plugins: [centerLabel]
  });
})();
</script>
{% endblock %}